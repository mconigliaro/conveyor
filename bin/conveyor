#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import absolute_import

import logging
import optparse
import os
import socket
import string
import sys
import time

if string.find(os.path.abspath(sys.argv[0]), os.sep+'conveyor') != -1:
    sys.path.insert(0, os.path.normpath(os.path.join(os.path.abspath(sys.argv[0]), os.pardir, os.pardir)))
if hasattr(os, "getuid") and os.getuid() != 0:
    sys.path.insert(0, os.path.abspath(os.getcwd()))

import conveyor
import conveyor.app_handlers


op = optparse.OptionParser("usage: %prog [options]")

og = optparse.OptionGroup(op, 'Session Options')
og.add_option('--servers',
              dest='servers',
              help="zookeeper connection string (default: %default)")
og.add_option('--timeout',
              dest='timeout',
              type='int',
              help="zookeeper connection timeout (default: %default)")
og.add_option('--host-id',
              dest='host_id',
              help="host id (default: %default)")
og.add_option('--groups',
              dest='groups',
              help="comma-separated list of groups")
op.add_option_group(og)

og = optparse.OptionGroup(op, 'Output and Logging Options')
og.add_option('--log-level',
              dest='log_level',
              type='choice',
              choices=['critical', 'error', 'warning', 'info', 'debug'],
              help="critical, error, warning, info, debug (default: %default)")
og.add_option('--log-file-path',
              dest='log_file_path',
              help="path for optional log file")
og.add_option('--log-file-rotate-interval-type',
              dest='log_file_rotate_interval_type',
              type='choice',
              choices=['s', 'm', 'h', 'd', 'w', 'midnight'],
              help="s=seconds, m=minutes, h=hours, d=days, w=week day (0=monday), midnight (default: %default)")
og.add_option('--log-file-rotate-interval',
              dest='log_file_rotate_interval',
              type='int',
              help="log rotation interval (default: %default)")
og.add_option('--log-file-max-backups',
              dest='log_file_max_backups',
              type='int',
              help="number of log files to keep when rotating (default: %default)")
op.add_option_group(og)

op.set_defaults(servers = 'localhost:2181/conveyor',
                timeout = 10,
                host_id = socket.getfqdn(),
                groups = [],
                log_level = 'info',
                log_file_rotate_interval_type = 'd',
                log_file_rotate_interval = 7,
                log_file_max_backups = 4)

(options, args) = op.parse_args()
if len(options.groups) > 0:
    groups = []
    for group in options.groups.split(','):
        groups.append(group.strip())
    options.groups = list(set(groups)) # remove duplicate groups


logging.getLogger().setLevel(getattr(logging, options.log_level.upper()))
console_logger = logging.StreamHandler()
console_logger.setFormatter(logging.Formatter("%(levelname)s: %(message)s"))
logging.getLogger().addHandler(console_logger)
if options.log_file_path:
    fileLogger = logging.handlers.TimedRotatingFileHandler(
        filename = options.log_file_path,
        when = options.log_file_rotate_interval_type,
        interval = options.log_file_rotate_interval,
        backupCount = options.log_file_max_backups)
    fileLogger.setFormatter(logging.Formatter("%(asctime)s %(levelname)s: %(message)s"))
    logging.getLogger().addHandler(fileLogger)


try:
    client = conveyor.Conveyor(servers=options.servers, timeout=options.timeout, host_id=options.host_id, groups=options.groups, app_handler=conveyor.app_handlers.Default)
    while True:
        time.sleep(1)

except KeyboardInterrupt:
    client.close()
