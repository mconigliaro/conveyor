#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import absolute_import

import ConfigParser
import optparse
import os
import pprint
import re
import string
import sys
import traceback

if string.find(os.path.abspath(sys.argv[0]), os.sep+'conveyor') != -1:
    sys.path.insert(0, os.path.normpath(os.path.join(os.path.abspath(sys.argv[0]), os.pardir, os.pardir)))
if hasattr(os, "getuid") and os.getuid() != 0:
    sys.path.insert(0, os.path.abspath(os.getcwd()))

import conveyor


config = ConfigParser.SafeConfigParser(defaults={
    'servers': 'localhost:2181/conveyor',
    'timeout': '10'
})
config.read([os.path.join(sys.path[0], './conf/hoist.conf'), '/etc/conveyor/hoist.conf'])


op = optparse.OptionParser("usage: %prog [options] [ application create NAME VERSION | < application | host > delete NAME | < application | host > list | < application | host > get NAME ]")

og = optparse.OptionGroup(op, 'Session Options')
og.add_option('--servers',
              dest='servers',
              default=config.get('session', 'servers'),
              help="zookeeper connection string (default: %default)")
og.add_option('--timeout',
              dest='timeout',
              type='int',
              default=config.getint('session', 'timeout'),
              help="zookeeper connection timeout (default: %default)")
op.add_option_group(og)

og = optparse.OptionGroup(op, 'Application Creation Options')
og.add_option('--groups',
              dest='groups',
              default='',
              help="comma-separated list of groups")
og.add_option('--slots',
              dest='slots',
              type='int',
              default=1,
              help="initial deployment slots (default: %default)")
og.add_option('--slot-increment',
              dest='slot_increment',
              type='int',
              default=1,
              help="deployment slot increment (default: %default)")
op.add_option_group(og)

(options, args) = op.parse_args()
options.groups = list(set(map(string.strip, options.groups.split(',')))) # remove duplicate groups


try:
    client = conveyor.Conveyor(servers=options.servers, timeout=options.timeout)

    args_str = ' '.join(args).strip()

    if re.match('^application create .+? .+?$', args_str):
        data = {
            'name': args[2],
            'version': args[3],
            'groups': options.groups,
            'slots': options.slots,
            'slot_increment': options.slot_increment
        }
        path = conveyor.zookeeper.path_join('applications', args[2])
        pprint.PrettyPrinter().pprint(conveyor.nodes.Application(path=path, data=data).write(handle=client.handle).data)

    elif re.match('^(application|host) delete .+?$', args_str):
        path = conveyor.zookeeper.path_join(args[0] + 's', args[2])
        conveyor.nodes.delete(handle=client.handle, path=path)

    elif re.match('^(application|host) list$', args_str):
        path = conveyor.zookeeper.path_join(args[0] + 's')
        pprint.PrettyPrinter().pprint(conveyor.nodes.list_children(handle=client.handle, path=path))

    elif re.match('^(application|host) get .+?$', args_str):
        class_name = getattr(conveyor.nodes, args[0].capitalize())
        path = conveyor.zookeeper.path_join(args[0] + 's', args[2])
        pprint.PrettyPrinter().pprint(class_name.read(handle=client.handle, path=path).data)

    else:
        op.print_help()
        sys.exit(1)

except SystemExit:
    sys.exit(1)

except:
    traceback.print_exc()
    sys.exit(1)

finally:
    client.close()
